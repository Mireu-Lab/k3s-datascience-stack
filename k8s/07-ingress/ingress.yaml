---
# Traefik Ingress Controller 설정
# K3s에 기본 포함된 Traefik 사용
apiVersion: v1
kind: Namespace
metadata:
  name: cert-manager
---
# cert-manager 설치를 위한 CRDs
# kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.crds.yaml
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@mireu.xyz  # 실제 이메일 주소로 변경
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: traefik
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: admin@mireu.xyz  # 실제 이메일 주소로 변경
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
    - http01:
        ingress:
          class: traefik
---
# JupyterHub Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jupyterhub-ingress
  namespace: datascience
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.middlewares: default-redirect-https@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
  - hosts:
    - jupyter.mireu.xyz
    secretName: jupyter-tls
  rules:
  - host: jupyter.mireu.xyz
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: proxy-public
            port:
              number: 80
---
# Spark Master UI Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: spark-master-ingress
  namespace: datascience
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    # Basic Auth (선택사항)
    traefik.ingress.kubernetes.io/router.middlewares: datascience-spark-auth@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
  - hosts:
    - spark.mireu.xyz
    secretName: spark-tls
  rules:
  - host: spark.mireu.xyz
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: spark-master-svc
            port:
              number: 8080
---
# Spark History Server Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: spark-history-ingress
  namespace: datascience
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.middlewares: datascience-spark-auth@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
  - hosts:
    - spark-history.mireu.xyz
    secretName: spark-history-tls
  rules:
  - host: spark-history.mireu.xyz
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: spark-history-server-svc
            port:
              number: 18080
---
# Hadoop NameNode UI Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hadoop-namenode-ingress
  namespace: storage
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.middlewares: storage-hadoop-auth@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
  - hosts:
    - hadoop.mireu.xyz
    secretName: hadoop-tls
  rules:
  - host: hadoop.mireu.xyz
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: hadoop-namenode
            port:
              number: 9870
---
# HTTP to HTTPS Redirect Middleware
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: redirect-https
  namespace: default
spec:
  redirectScheme:
    scheme: https
    permanent: true
---
# Basic Auth Middleware for Spark (datascience namespace)
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: spark-auth
  namespace: datascience
spec:
  basicAuth:
    secret: spark-basic-auth
---
# Basic Auth Middleware for Hadoop (storage namespace)
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: hadoop-auth
  namespace: storage
spec:
  basicAuth:
    secret: hadoop-basic-auth
---
# Basic Auth Secret for Spark
# 생성 방법: htpasswd -nb admin password | base64
apiVersion: v1
kind: Secret
metadata:
  name: spark-basic-auth
  namespace: datascience
type: Opaque
data:
  users: YWRtaW46JGFwcjEkSDY1dnlWWUkkRjJWNy9aYkYyS0oyMll5cjVRd0NiMAo=
  # admin:admin (변경 필요!)
---
# Basic Auth Secret for Hadoop
apiVersion: v1
kind: Secret
metadata:
  name: hadoop-basic-auth
  namespace: storage
type: Opaque
data:
  users: YWRtaW46JGFwcjEkSDY1dnlWWUkkRjJWNy9aYkYyS0oyMll5cjVRd0NiMAo=
  # admin:admin (변경 필요!)

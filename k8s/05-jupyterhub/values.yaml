# JupyterHub with Google OAuth and JAX GPU Support

proxy:
  secretToken: "GENERATE_SECRET_TOKEN_HERE"  # openssl rand -hex 32
  service:
    type: ClusterIP
  
hub:
  baseUrl: /
  
  db:
    type: sqlite-pvc
    pvc:
      storageClassName: nvme-hot-storage
      accessModes:
        - ReadWriteOnce
      storage: 10Gi

  resources:
    requests:
      memory: "2Gi"
      cpu: "1000m"
    limits:
      memory: "4Gi"
      cpu: "2000m"

  extraConfig:
    # Google OAuth 설정
    00-oauth: |
      from oauthenticator.google import GoogleOAuthenticator
      c.JupyterHub.authenticator_class = GoogleOAuthenticator
      
      c.GoogleOAuthenticator.client_id = 'YOUR_GOOGLE_CLIENT_ID'
      c.GoogleOAuthenticator.client_secret = 'YOUR_GOOGLE_CLIENT_SECRET'
      c.GoogleOAuthenticator.oauth_callback_url = 'https://jupyter.mireu.xyz/hub/oauth_callback'
      
      # 허용된 도메인 (선택사항)
      # c.GoogleOAuthenticator.hosted_domain = ['mireu.xyz']
      # c.GoogleOAuthenticator.login_service = 'Mireu Analytics'
      
      # 관리자 설정
      c.Authenticator.admin_users = {'admin@mireu.xyz'}
      c.Authenticator.allowed_users = {'user1@mireu.xyz', 'user2@mireu.xyz'}
    
    # 네임스페이스별 사용자 격리
    01-namespace: |
      import hashlib
      
      def get_user_namespace(spawner):
          """각 사용자/프로젝트를 별도 네임스페이스에 배포"""
          username = spawner.user.name.split('@')[0].replace('.', '-')
          return f"jupyter-{username}"
      
      c.KubeSpawner.namespace = get_user_namespace
      c.KubeSpawner.enable_user_namespaces = True
    
    # 프로필 설정 (리소스별 선택)
    02-profiles: |
      c.KubeSpawner.profile_list = [
          {
              'display_name': 'Minimal (CPU Only)',
              'description': 'Basic environment for light analysis',
              'kubespawner_override': {
                  'image': 'jupyter/minimal-notebook:latest',
                  'cpu_limit': 2,
                  'cpu_guarantee': 1,
                  'mem_limit': '4G',
                  'mem_guarantee': '2G',
              }
          },
          {
              'display_name': 'Data Science (CPU)',
              'description': 'Full data science stack with Spark/PostgreSQL/HDFS',
              'kubespawner_override': {
                  'image': 'jupyter/datascience-notebook:latest',
                  'cpu_limit': 4,
                  'cpu_guarantee': 2,
                  'mem_limit': '16G',
                  'mem_guarantee': '8G',
              }
          },
          {
              'display_name': 'GPU + JAX (ML/DL/RL)',
              'description': 'NVIDIA GPU with JAX for machine learning',
              'default': True,
              'kubespawner_override': {
                  'image': 'YOUR_REGISTRY/jupyter-jax-gpu:latest',  # 별도 빌드 필요
                  'cpu_limit': 8,
                  'cpu_guarantee': 4,
                  'mem_limit': '32G',
                  'mem_guarantee': '16G',
                  'extra_resource_limits': {
                      'nvidia.com/gpu': '1'
                  },
                  'extra_resource_guarantees': {
                      'nvidia.com/gpu': '1'
                  },
                  'node_selector': {
                      'nvidia.com/gpu': 'true'
                  },
              }
          },
      ]
    
    # 데이터 저장소 마운트
    03-storage: |
      c.KubeSpawner.volumes = [
          {
              'name': 'nvme-hot-storage',
              'persistentVolumeClaim': {
                  'claimName': 'nvme-hot-pvc'
              }
          },
          {
              'name': 'hdd-cold-storage',
              'persistentVolumeClaim': {
                  'claimName': 'hdd-cold-pvc'
              }
          },
          {
              'name': 'user-storage',
              'persistentVolumeClaim': {
                  'claimName': '{username}-pvc'
              }
          }
      ]
      
      c.KubeSpawner.volume_mounts = [
          {
              'name': 'nvme-hot-storage',
              'mountPath': '/mnt/hot-data'
          },
          {
              'name': 'hdd-cold-storage',
              'mountPath': '/mnt/cold-data'
          },
          {
              'name': 'user-storage',
              'mountPath': '/home/jovyan/work'
          }
      ]
    
    # 환경 변수 설정
    04-environment: |
      c.KubeSpawner.environment = {
          'SPARK_MASTER': 'spark://spark-master-svc.datascience.svc.cluster.local:7077',
          'POSTGRES_HOST': 'postgresql.storage.svc.cluster.local',
          'POSTGRES_PORT': '5432',
          'POSTGRES_DB': 'analytics',
          'HDFS_NAMENODE': 'hdfs://hadoop-namenode.storage.svc.cluster.local:9000',
          'GRANT_SUDO': 'yes',
          'JUPYTER_ENABLE_LAB': 'yes',
      }

  nodeSelector:
    kubernetes.io/hostname: ""  # 실제 노드 호스트명

singleuser:
  storage:
    dynamic:
      storageClass: nvme-hot-storage
    capacity: 50Gi
    homeMountPath: /home/jovyan
  
  image:
    name: jupyter/datascience-notebook
    tag: latest
    pullPolicy: IfNotPresent
  
  defaultUrl: "/lab"
  
  lifecycleHooks:
    postStart:
      exec:
        command:
          - "sh"
          - "-c"
          - |
            # Spark, PostgreSQL, HDFS 라이브러리 설치
            pip install --quiet pyspark psycopg2-binary hdfs pyarrow findspark
            # JAX 설치 (GPU 프로필에서만)
            if [ -d "/usr/local/cuda" ]; then
              pip install --quiet "jax[cuda12_pip]" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html
            fi
  
  networkPolicy:
    enabled: true
    allowedIngressPorts: [8888]
    egress:
      - to:
        - namespaceSelector:
            matchLabels:
              name: storage
        - namespaceSelector:
            matchLabels:
              name: datascience
      - to:
        - namespaceSelector: {}
        ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
      - to:
        - podSelector: {}
        ports:
        - protocol: TCP
          port: 443
  
  extraEnv:
    JUPYTER_ENABLE_LAB: "yes"
    GRANT_SUDO: "yes"
    
  # 추가 패키지 설치
  extraFiles:
    jupyter_notebook_config.json:
      mountPath: /home/jovyan/.jupyter/jupyter_notebook_config.json
      data:
        ServerApp:
          terminals_enabled: true
        NotebookApp:
          allow_origin: '*'
          tornado_settings:
            headers:
              Content-Security-Policy: "frame-ancestors 'self' https://*.mireu.xyz"

ingress:
  enabled: true
  annotations:
    kubernetes.io/ingress.class: traefik
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.tls: "true"
  hosts:
    - jupyter.mireu.xyz
  tls:
    - secretName: jupyter-tls
      hosts:
        - jupyter.mireu.xyz

scheduling:
  userScheduler:
    enabled: false
  
  userPlaceholder:
    enabled: false

cull:
  enabled: true
  timeout: 3600  # 1시간
  every: 600     # 10분마다 체크

prePuller:
  hook:
    enabled: true
  continuous:
    enabled: false

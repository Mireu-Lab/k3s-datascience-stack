# deployments/jupyterhub/values.yaml
proxy:
  secretToken: "generate-a-long-random-string"
  service:
    type: ClusterIP
  # Disable internal HTTPS; TLS is handled by Traefik (TLS Offloading)
  https:
    enabled: false

ingress:
  enabled: true
  ingressClassName: traefik
  hosts:
    - jupyter.mireu.xyz
  annotations:
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.middlewares: kube-system-https-redirect@kubernetescrd
    cert-manager.io/cluster-issuer: "letsencrypt-production"
  tls:
    - hosts:
        - jupyter.mireu.xyz
      secretName: jupyterhub-tls

hub:
  serviceAccount:
    create: true
  extraEnv:
    OAUTH_CLIENT_ID:
      valueFrom:
        secretKeyRef:
          name: google-oauth-secret
          key: clientId
    OAUTH_CLIENT_SECRET:
      valueFrom:
        secretKeyRef:
          name: google-oauth-secret
          key: clientSecret
    OAUTH_CALLBACK_URL:
      valueFrom:
        secretKeyRef:
          name: google-oauth-secret
          key: oauthCallbackUrl
  config:
    JupyterHub:
      authenticator_class: google
      allow_named_servers: true
      spawner_class: "kubespawner.KubeSpawner"
      # Trust downstream proxy IPs and protocol headers for TLS offloading
      trusted_downstream_ips:
        - 10.42.0.0/16 # K3s default pod CIDR
        - 10.43.0.0/16 # K3s default service CIDR
    Authenticator:
      admin_users:
        - limmireu1214@gmail.com
    GoogleOAuthenticator:
      login_service: "Google"
    KubeSpawner:
      extra_resource_limits:
        nvidia.com/gpu: "1"
      volumes:
        - name: hdfs-data
          persistentVolumeClaim:
            claimName: hdfs-cluster-datanode-default
      volume_mounts:
        - name: hdfs-data
          mountPath: /mnt/hdfs

# [x] ROOT 권한 허용
singleuser:
  image:
    name: ghcr.io/mireu-lab/k3s-datascience-stack
    tag: main
  uid: 0
  fsGid: 0
  storage:
    type: dynamic
    capacity: 20Gi
    dynamic:
      storageClass: "local-path"
  extraEnv:
    JUPYTER_ENABLE_LAB: "yes"
    LD_LIBRARY_PATH: "/usr/local/nvidia/lib64"
    SPARK_MASTER: "spark://spark-master:7077"
    POSTGRES_HOST: "postgres-db-rw"
    HDFS_NAMENODE: "hdfs-cluster"
    GIT_REPO_URL: "https://github.com/Mireu-Lab/k3s-datascience-stack"
    GIT_REPO_NAME: "default-repo"

rbac:
  create: true

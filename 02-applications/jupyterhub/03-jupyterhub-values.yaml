# 02-applications/jupyterhub/03-jupyterhub-values.yaml
hub:
  config:
    JupyterHub:
      spawner_class: kubespawner.KubeSpawner
    KubeSpawner:
      # 각 사용자를 위한 네임스페이스 자동 생성
      namespace: "jhub-user-{username}"
      # 사용자 포드에 대한 기본 권한 설정 (Spark 실행용)
      pod_template_spec:
        serviceAccountName: "spark"
      events_enabled: true
    # --- Google OAuth 설정 ---
    # GCP에서 OAuth 2.0 클라이언트 ID를 생성한 후 아래 값을 채워주세요.
    # https://console.cloud.google.com/apis/credentials
    GoogleOAuthenticator:
      client_id: "YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com"
      client_secret: "YOUR_GOOGLE_CLIENT_SECRET"
      oauth_callback_url: "https://jupyter.mireu.xyz/hub/oauth_callback"
      hosted_domain:
        - "mireu.xyz" # mireu.xyz 도메인 계정만 로그인 허용 (선택 사항)
      admin_users:
        - "admin@mireu.xyz" # 관리자 계정
  # JupyterHub 데이터베이스용 영구 볼륨
  db:
    type: "pvc"
    pvc:
      name: "jupyterhub-db-pvc"
      storageClassName: "nvme-hot-storage"

proxy:
  # LoadBalancer 대신 ClusterIP와 Cloudflare Tunnel을 사용
  service:
    type: ClusterIP
  # HTTPS를 Cloudflare에서 처리하므로 내부에서는 http 사용
  https:
    enabled: false

singleuser:
  # 위에서 빌드한 사용자 Docker 이미지
  image:
    name: "your-dockerhub-username/jupyter-data-server"
    tag: "latest"
  # GPU 리소스 할당
  extraResourceLimits:
    nvidia.com/gpu: "1"
  # 사용자별 영구 스토리지 마운트
  storage:
    type: "dynamic"
    capacity: 20Gi
    home_mount_path: "/home/jovyan/work"
    storageClassName: "nvme-hot-storage" # 기본 작업 공간은 NVMe
  # Cold Storage (HDD) 추가 마운트
  extraVolumes:
    - name: cold-storage
      persistentVolumeClaim:
        claimName: "user-{username}-cold-pvc"
  extraVolumeMounts:
    - name: cold-storage
      mountPath: "/home/jovyan/cold"
  # Spark on K8s 설정
  startTimeout: 300
  lifecycleHooks:
    postStart:
      exec:
        command:
          - "sh"
          - "-c"
          - >
            kubectl create serviceaccount spark --namespace=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace);
            kubectl create clusterrolebinding spark-role --clusterrole=edit --serviceaccount=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace):spark --namespace=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace);

# RBAC 설정: JupyterHub가 네임스페이스, 포드 등을 관리할 수 있도록 권한 부여
rbac:
  enabled: true
  # 사용자 네임스페이스 자동 생성을 위한 권한
  userNamespaces:
    enabled: true

# JupyterHub 설치 명령어:
# helm repo add jupyterhub https://jupyterhub.github.io/helm-chart/
# helm repo update
# helm upgrade --cleanup-on-fail \
#   --install jupyterhub jupyterhub/jupyterhub \
#   --namespace jupyterhub \
#   --create-namespace \
#   --version=3.2.0 \
#   --values 03-jupyterhub-values.yaml
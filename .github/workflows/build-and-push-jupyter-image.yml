# 워크플로우의 이름
name: Build and Push Jupyter User Image

# 워크플로우가 실행될 조건 (트리거)
on:
  # 1. 'main' 브랜치에 push 이벤트가 발생했을 때
  push:
    branches: [ "main" ]
  # 2. 이 워크플로우를 수동으로 실행할 수 있도록 버튼 추가
  workflow_dispatch:

# 실행될 작업(job) 목록
jobs:
  # 작업 ID
  build-and-push:
    # 이 작업이 실행될 가상 환경
    runs-on: ubuntu-latest

    # 작업의 단계(step)들
    steps:
      # 1. 소스 코드 체크아웃
      #   - 현재 리포지토리의 코드를 가상 환경으로 가져옵니다.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Docker Hub에 로그인
      #   - GitHub Secrets에 저장된 사용자 이름과 토큰을 사용하여 로그인합니다.
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. 이미지 메타데이터 추출 (태그 생성)
      #   - 이미지에 사용할 태그를 자동으로 생성합니다.
      #   - 예: 'latest' 태그, 커밋 해시 태그 (예: 'sha-abcdef1')
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/jupyter-data-server

      # 4. Docker 이미지 빌드 및 푸시
      #   - Dockerfile을 사용하여 이미지를 빌드하고 Docker Hub에 푸시합니다.
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # Dockerfile이 있는 디렉토리 경로
          context: ./02-applications/jupyterhub/user-image
          # 푸시할 것인지 여부 (true)
          push: true
          # 위 'meta' 단계에서 생성된 태그들을 사용
          tags: ${{ steps.meta.outputs.tags }}
          # 'meta' 단계에서 생성된 라벨들을 사용
          labels: ${{ steps.meta.outputs.labels }}
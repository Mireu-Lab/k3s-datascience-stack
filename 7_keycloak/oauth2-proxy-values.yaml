# OAuth2 Proxy Configuration for Keycloak Integration
# This proxy protects all services with centralized authentication

config:
  # Keycloak OIDC configuration
  clientID: "oauth2-proxy"
  clientSecret: "JSd1AIePQAxsXglKKfACJYzLmp9jStbF"
  cookieSecret: "NFTIxXvSVBZC0a6DxL5ZMGFqVbeBFd11N2VL6eyWpS8="
  
  configFile: |-
    # OAuth provider
    provider = "keycloak-oidc"
    provider_display_name = "Keycloak (Google)"
    
    # Email domain (allow all)
    email_domains = ["*"]
    
    # Keycloak URLs (use external URL for issuer to match JWT, but skip TLS verification for internal calls)
    oidc_issuer_url = "https://keycloak.mireu.xyz/auth/realms/researchope"
    login_url = "https://keycloak.mireu.xyz/auth/realms/researchope/protocol/openid-connect/auth"
    redeem_url = "https://keycloak.mireu.xyz/auth/realms/researchope/protocol/openid-connect/token"
    validate_url = "https://keycloak.mireu.xyz/auth/realms/researchope/protocol/openid-connect/userinfo"
    oidc_jwks_url = "https://keycloak.mireu.xyz/auth/realms/researchope/protocol/openid-connect/certs"
    
    # Skip TLS verification for internal cluster communication
    ssl_insecure_skip_verify = true
    
    # Redirect URL (OAuth2 Proxy callback)
    redirect_url = "https://auth.mireu.xyz/oauth2/callback"
    
    # Cookie settings for *.mireu.xyz
    cookie_name = "_oauth2_proxy"
    cookie_domains = [".mireu.xyz"]  # Share cookie across all subdomains
    cookie_secure = true
    cookie_httponly = true
    cookie_samesite = "lax"
    cookie_refresh = "1h"
    cookie_expire = "168h"  # 7 days
    
    # Email domain restriction (optional)
    # email_domains = ["*"]
    
    # Authenticated email addresses (optional - restrict to specific users)
    # authenticated_emails_file = "/etc/oauth2-proxy/authenticated-emails.txt"
    
    # Skip authentication for specific paths (optional)
    skip_auth_regex = [
      "^/health$",
      "^/ping$"
    ]
    
    # Pass user information to backend
    pass_access_token = true
    pass_user_headers = true
    pass_authorization_header = true
    set_xauthrequest = true
    set_authorization_header = true
    
    # Upstream (not used in ForwardAuth mode, but required)
    upstreams = ["static://200"]
    
    # Logging
    request_logging = true
    auth_logging = true
    standard_logging = true

# Service configuration
service:
  type: ClusterIP
  portNumber: 4180

# Ingress for OAuth2 Proxy itself (callback URL)
ingress:
  enabled: false  # We'll use Traefik IngressRoute

# Resources
resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 50m
    memory: 64Mi

# Replicas
replicaCount: 1

# Additional configuration
extraArgs:
  - --cookie-csrf-per-request=true
  - --cookie-csrf-expire=15m
  - --whitelist-domain=.mireu.xyz
  - --proxy-prefix=/oauth2
  - --http-address=0.0.0.0:4180
  - --reverse-proxy=true

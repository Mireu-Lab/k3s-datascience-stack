---
# JWT Authentication Middleware for *.mireu.xyz domain
# This middleware validates JWT tokens issued by Keycloak for all services
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: jwt-auth
  namespace: traefik
spec:
  forwardAuth:
    address: http://keycloak-service.keycloak.svc.cluster.local:8080/realms/researchope/protocol/openid-connect/token/introspect
    trustForwardHeader: true
    authResponseHeaders:
      - X-Auth-User
      - X-Auth-Email
      - X-Auth-Roles
      - X-Auth-Groups
    authRequestHeaders:
      - Authorization
---
# Alternative: OAuth2 Proxy Middleware (if oauth2-proxy is deployed)
# This provides a better user experience with redirect to login
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: oauth2-proxy
  namespace: traefik
spec:
  forwardAuth:
    address: http://oauth2-proxy.keycloak.svc.cluster.local:4180
    trustForwardHeader: true
    authResponseHeaders:
      - X-Auth-Request-User
      - X-Auth-Request-Email
      - X-Auth-Request-Access-Token
---
# Rate Limiting Middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: traefik
spec:
  rateLimit:
    average: 100
    burst: 50
    period: 1m
---
# Security Headers Middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: traefik
spec:
  headers:
    customResponseHeaders:
      X-Frame-Options: "SAMEORIGIN"
      X-Content-Type-Options: "nosniff"
      X-XSS-Protection: "1; mode=block"
      Referrer-Policy: "strict-origin-when-cross-origin"
    sslRedirect: true
    stsSeconds: 31536000
    stsIncludeSubdomains: true
    stsPreload: true
---
# CORS Middleware for API endpoints
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cors-headers
  namespace: traefik
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
    accessControlAllowHeaders:
      - "*"
    accessControlAllowOriginList:
      - "https://*.mireu.xyz"
    accessControlMaxAge: 3600
    addVaryHeader: true
---
# Compression Middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: compression
  namespace: traefik
spec:
  compress:
    excludedContentTypes:
      - text/event-stream
